<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <title>Radar de Limites</title>

  <!-- Fonte local -->
  <style>
    @font-face {
      font-family: 'MinhaFonte';
      src: url('JTUSjIg1_i6t8kCHKm459Wlhyw.woff2') format('woff2');
      font-weight: normal;
      font-style: normal;
    }

    body {
      font-family: 'MinhaFonte', sans-serif;
      background:#000;
      color:#fff;
      min-height:100vh;
      margin:0;
      display:flex;
      flex-direction:column;
      align-items:center;
    }

    .container {display:flex;flex-direction:column;align-items:center;width:100%;}
    h2 {margin:20px 0 10px 0;}
    button {margin:10px;padding:10px 20px;border:none;border-radius:6px;background:#1e40af;color:white;font-weight:600;cursor:pointer;font-family:'MinhaFonte',sans-serif;}
    button:hover {background:#2563eb;}
    table {border-collapse:collapse;margin-top:20px;background:#111;text-align:center;width:95%;}
    th,td {border:1px solid #333;padding:12px;}
    th {background:#222;}
    tr.green {background:#064e3b;}
    tr.yellow {background:#b3b300;}
    tr.orange {background:#ffa500;}
    tr.red {background:#7f1d1d;color:#fff;}
    .modal {display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);align-items:center;justify-content:center;}
    .modal-content {background:#111;padding:20px;border-radius:8px;width:360px;text-align:center;}
    .modal-content h3 {margin-top:0;}
    .modal-content input,.modal-content select {
      width:90%;margin:8px 0;padding:8px;border:none;border-radius:4px;background:#222;color:#fff;text-align:center;
      font-family:'MinhaFonte', sans-serif;
    }
    .modal-content select {appearance:none;-webkit-appearance:none;-moz-appearance:none;}
    .modal-content button {margin-top:10px;}
    #searchCpf {margin:10px 0;padding:8px;border:none;border-radius:4px;background:#222;color:#fff;text-align:center;width:200px;}
  </style>

  <script src="https://www.gstatic.com/firebasejs/10.3.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.3.1/firebase-firestore-compat.js"></script>
</head>
<body>
  <div class="container">

  <!-- Linha com logo e título centralizado -->
  <div style="display:flex;align-items:center;justify-content:space-between;width:95%;margin-bottom:10px;">
    <!-- Coluna Esquerda -->
    <div style="flex:1;display:flex;justify-content:flex-start;">
      <img src="https://tentoscapwebmanagerproduction.azurewebsites.net/brand/logo.svg" 
           alt="Logo TentosCap" style="height:100px;">
    </div>

    <!-- Coluna Centro -->
    <div style="flex:1;display:flex;justify-content:center;">
      <h2 style="margin:0;">Radar de Limites</h2>
    </div>

    <!-- Coluna Direita (apenas para balancear) -->
    <div style="flex:1;"></div>
  </div>

  <!-- Barra de pesquisa CPF -->
  <input id="searchCpf" placeholder="Pesquisar CPF" maxlength="14">

  <!-- Linha dos botões -->
  <div>
    <button onclick="openModal('tomar')">Tomar Crédito</button>
    <button onclick="openModal('gestao')">Gestão de Limites</button>
    <button onclick="openModal('consulta')">Consulta Limites</button>
  </div>

  <!-- Tabela -->
  <table id="tabela">
    <thead>
      <tr>
        <th>Nº</th>
        <th>Nome</th>
        <th>CPF</th>
        <th>Produto</th>
        <th>Limite Total</th>
        <th>Tomado</th>
        <th>% Tomado</th>
        <th>Disponível</th>
        <th>% Disponível</th>
        <th>Data Aprovação</th>
        <th>Data da Tomada</th>
        <th>Data Expiração</th>
        <th>Dias até Expiração</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

  <!-- Modal Tomar -->
  <div class="modal" id="modalTomar">
    <div class="modal-content">
      <h3>Tomar Crédito</h3>
      <input id="cpfTomar" placeholder="CPF" maxlength="14">
      <select id="produtoTomar">
        <option value="Créd. Rural">Créd. Rural</option>
        <option value="CPR">CPR</option>
        <option value="Cartão">Cartão</option>
      </select>
      <input id="valorTomar" placeholder="Valor a Tomar">
      <button onclick="tomarCredito()">Confirmar</button>
      <button onclick="closeModal('tomar')">Fechar</button>
    </div>
  </div>

  <!-- Modal Gestão de Limites -->
  <div class="modal" id="modalGestao">
    <div class="modal-content">
      <h3>Gestão de Limites</h3>
      <input id="nomeGestao" placeholder="Nome">
      <input id="cpfGestao" placeholder="CPF" maxlength="14">
      <input id="globalLimite" placeholder="Limite Global">
      <input id="limiteRural" placeholder="Limite Créd. Rural">
      <input id="limiteCPR" placeholder="Limite CPR">
      <input id="limiteCartao" placeholder="Limite Cartão">
      <input id="aprovacaoGestao" type="date">
      <button onclick="definirLimites()">Salvar</button>
      <button onclick="closeModal('gestao')">Fechar</button>
    </div>
  </div>

  <!-- Modal Consulta de Limites -->
  <div class="modal" id="modalConsulta">
    <div class="modal-content" style="width: 90%; max-width: 700px;">
      <h3>Consulta de Limites</h3>
      <input id="cpfConsulta" placeholder="CPF" maxlength="14">
      <button onclick="consultarLimites()">Consultar</button>
      <div id="consultaResultado" style="margin-top:10px;text-align:center;width:100%;"></div>
      <button onclick="closeModal('consulta')">Fechar</button>
    </div>
  </div>

<script>
const firebaseConfig={apiKey:"AIzaSyBzkv1c6w0hTcJs-Cydqr1H4mHMmHUDDwE",authDomain:"limites-fd5a6.firebaseapp.com",projectId:"limites-fd5a6",storageBucket:"limites-fd5a6.appspot.com",messagingSenderId:"51777773197",appId:"1:51777773197:web:c998aed25346219aeecf14"};
firebase.initializeApp(firebaseConfig);
const db=firebase.firestore();
let limites=[];let limitesGlobais={};let filtroCpf="";

function openModal(tipo){document.getElementById("modal"+tipo.charAt(0).toUpperCase()+tipo.slice(1)).style.display='flex';}
function closeModal(tipo){document.getElementById("modal"+tipo.charAt(0).toUpperCase()+tipo.slice(1)).style.display='none';}
function diasEntre(data){return Math.floor((new Date()-new Date(data+"T00:00:00"))/(1000*60*60*24));}
function formatCPF(cpf){return cpf.replace(/\D/g,"").replace(/(\d{3})(\d{3})(\d{3})(\d{2})/,"$1.$2.$3-$4");}
function formatMoney(v){return v.toLocaleString("pt-BR",{style:"currency",currency:"BRL"});}

function render(){
  const tbody=document.querySelector("#tabela tbody");
  tbody.innerHTML="";
  limites.filter(l=>!filtroCpf||l.cpf.includes(filtroCpf)).forEach((l,index)=>{
    const tr=document.createElement("tr");
    const aprov=new Date(l.dataAprovacao+"T00:00:00");
    const dias=diasEntre(l.dataAprovacao);
    let disponivel=l.limiteTotal-l.tomado;
    let percTomado=l.limiteTotal>0?((l.tomado/l.limiteTotal)*100).toFixed(1):"0.0";
    let percDisponivel=l.limiteTotal>0?((disponivel/l.limiteTotal)*100).toFixed(1):"0.0";
    let expStr="",diasVenc="",classe="",tomadaStr=l.dataTomada?new Date(l.dataTomada).toLocaleDateString("pt-BR"):"-";
    let status=l.ativo?"Ativo":"Inativo";
    if(l.ativo && l.tomado>0 && l.tomado<l.limiteTotal){status="Parcial";}

    if(!l.ativo){
      classe="red";expStr="INATIVO";diasVenc="INATIVO";disponivel=0;
    } else if(dias>90){
      classe="red";expStr="EXPIRADO";diasVenc="EXPIRADO";disponivel=0;l.ativo=false;status="Inativo";
    } else if(disponivel<=0){
      classe="red";expStr="TOMADO";diasVenc="TOMADO";status="Inativo";
    } else if(dias<=7){
      classe="green";expStr=new Date(aprov.getTime()+90*86400000).toLocaleDateString("pt-BR");diasVenc=90-dias;
    } else if(dias<=30){
      classe="yellow";expStr=new Date(aprov.getTime()+90*86400000).toLocaleDateString("pt-BR");diasVenc=90-dias;
    } else {
      classe="orange";expStr=new Date(aprov.getTime()+90*86400000).toLocaleDateString("pt-BR");diasVenc=90-dias;
    }

    tr.className=classe;
    tr.innerHTML=`
      <td>${index+1}</td>
      <td>${l.nome}</td>
      <td>${formatCPF(l.cpf)}</td>
      <td>${l.produto}</td>
      <td>${formatMoney(l.limiteTotal)}</td>
      <td>${formatMoney(l.tomado)}</td>
      <td>${percTomado}%</td>
      <td>${formatMoney(disponivel)}</td>
      <td>${percDisponivel}%</td>
      <td>${new Date(l.dataAprovacao+"T00:00:00").toLocaleDateString("pt-BR")}</td>
      <td>${tomadaStr}</td>
      <td>${expStr}</td>
      <td>${diasVenc}</td>
      <td>${status}</td>`;
    tbody.appendChild(tr);
  });
}

async function carregarDoFirebase(){
  let snapshot=await db.collection("limites").get();
  limites=[];snapshot.forEach(doc=>{limites.push(doc.data());});
  render();
}

async function salvarNoFirebase(limite,cpf,seq){
  await db.collection("limites").doc(cpf+"_"+seq).set(limite);
}

async function definirLimites(){
  const nome=document.getElementById("nomeGestao").value;
  const cpf=document.getElementById("cpfGestao").value.replace(/\D/g,"");
  const global=parseFloat(document.getElementById("globalLimite").value.replace(/\D/g,""))/100;
  const rural=parseFloat(document.getElementById("limiteRural").value.replace(/\D/g,""))/100;
  const cpr=parseFloat(document.getElementById("limiteCPR").value.replace(/\D/g,""))/100;
  const cartao=parseFloat(document.getElementById("limiteCartao").value.replace(/\D/g,""))/100;
  const aprov=document.getElementById("aprovacaoGestao").value;

  if(!nome||!cpf||cpf.length!==11||!global||!aprov)return alert("Preencha todos os campos corretamente");
  if(rural>global||cpr>global||cartao>global)return alert("Nenhum limite de produto pode ser maior que o global");

  let produtos={"Créd. Rural":rural,"CPR":cpr,"Cartão":cartao};
  let seq=Date.now();

  // salva global separado
  await db.collection("limitesGlobais").doc(cpf).set({cpf,nome,global,data:aprov});
  limitesGlobais[cpf]={global,produtos};

  for(const prod in produtos){
    if(produtos[prod]>0){
      // inativar antigos
      let snap=await db.collection("limites").where("cpf","==",cpf).where("produto","==",prod).where("ativo","==",true).get();
      snap.forEach(doc=>{doc.ref.update({ativo:false});});
      let novo={nome,cpf,produto:prod,limiteTotal:produtos[prod],tomado:0,dataAprovacao:aprov,dataTomada:null,ativo:true};
      await salvarNoFirebase(novo,cpf,seq+"_"+prod);
      limites.push(novo);
    }
  }
  closeModal('gestao');alert("Limites salvos!");render();
}

function tomarCredito(){
  const cpf=document.getElementById("cpfTomar").value.replace(/\D/g,"");
  const produto=document.getElementById("produtoTomar").value;
  const valor=parseFloat(document.getElementById("valorTomar").value.replace(/\D/g,""))/100;

  let cliente=limites.find(l=>l.cpf===cpf&&l.produto===produto&&l.ativo);
  if(!cliente)return alert("Limite não encontrado ou inativo");

  const dias=diasEntre(cliente.dataAprovacao);
  if(dias>90)return alert("Limite expirado");

  let disponivel=cliente.limiteTotal-cliente.tomado;
  if(valor>disponivel)return alert("Valor maior que disponível");

  const regras=limitesGlobais[cpf];
  if(regras){
    let somaTomados=limites.filter(l=>l.cpf===cpf).reduce((s,l)=>s+l.tomado,0);
    if(somaTomados+valor>regras.global)return alert("Ultrapassa o limite global!");
    let tomadoProd=limites.filter(l=>l.cpf===cpf&&l.produto===produto).reduce((s,l)=>s+l.tomado,0);
    if(tomadoProd+valor>regras.produtos[produto])return alert("Ultrapassa o limite do produto!");
  }

  cliente.tomado+=valor;cliente.dataTomada=new Date().toISOString();
  render();
  db.collection("limites").where("cpf","==",cpf).where("produto","==",produto).where("ativo","==",true).get().then(snap=>{
    snap.forEach(doc=>{doc.ref.update(cliente);});
  });
  closeModal('tomar');
}

async function consultarLimites(){
  const cpf=document.getElementById("cpfConsulta").value.replace(/\D/g,"");
  if(!cpf)return alert("Informe CPF");
  let globalDoc=await db.collection("limitesGlobais").doc(cpf).get();
  if(!globalDoc.exists)return alert("CPF não encontrado");
  const regras=globalDoc.data();

  let html="<table style='width:100%;border-collapse:collapse;text-align:center;'><tr><th>Produto</th><th>Limite</th><th>Tomado</th><th>Disponível</th></tr>";
  let somaTomado=limites.filter(l=>l.cpf===cpf).reduce((s,l)=>s+l.tomado,0);
  let dispGlobal=regras.global-somaTomado;
  html+=`<tr><td><b>Global</b></td><td>${formatMoney(regras.global)}</td><td>${formatMoney(somaTomado)}</td><td>${formatMoney(dispGlobal)}</td></tr>`;
  ["Créd. Rural","CPR","Cartão"].forEach(prod=>{
    let tomado=limites.filter(l=>l.cpf===cpf&&l.produto===prod).reduce((s,l)=>s+l.tomado,0);
    let disp=regras.produtos?regras.produtos[prod]-tomado:0;
    let limiteFixado=regras.produtos?regras.produtos[prod]:0;
    html+=`<tr><td>${prod}</td><td>${formatMoney(limiteFixado)}</td><td>${formatMoney(tomado)}</td><td>${formatMoney(disp)}</td></tr>`;
  });
  html+="</table>";
  document.getElementById("consultaResultado").innerHTML=html;
}

function aplicarMascaraCPF(input){input.addEventListener("input",()=>{let v=input.value.replace(/\D/g,"");if(v.length>11)v=v.slice(0,11);input.value=v.replace(/(\d{3})(\d{3})(\d{3})(\d{0,2})/,(m,p1,p2,p3,p4)=>p4?`${p1}.${p2}.${p3}-${p4}`:`${p1}.${p2}.${p3}`);});}
function aplicarMascaraMoeda(input){input.addEventListener("input",()=>{let v=input.value.replace(/\D/g,"");if(v==="")v="0";v=(parseFloat(v)/100).toFixed(2);input.value=v.replace(".",",").replace(/\B(?=(\d{3})+(?!\d))/g,".");});}

window.onload=function(){
  carregarDoFirebase();
  ["cpfTomar","cpfGestao","cpfConsulta","searchCpf"].forEach(id=>aplicarMascaraCPF(document.getElementById(id)));
  ["valorTomar","globalLimite","limiteRural","limiteCPR","limiteCartao"].forEach(id=>aplicarMascaraMoeda(document.getElementById(id)));
  document.getElementById("searchCpf").addEventListener("input",e=>{filtroCpf=e.target.value.replace(/\D/g,"");render();});
};
</script>
</body>
</html>
