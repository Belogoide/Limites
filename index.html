<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <title>Radar de Limites</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/10.3.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.3.1/firebase-firestore-compat.js"></script>
  <style>
    body {font-family:'Montserrat',sans-serif;background:#000;color:#fff;display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;margin:0;}
    h2 {margin-bottom:10px;}
    button {margin:10px;padding:10px 20px;border:none;border-radius:6px;background:#1e40af;color:white;font-weight:600;cursor:pointer;}
    button:hover {background:#2563eb;}
    table {border-collapse:collapse;margin-top:20px;background:#111;text-align:center;}
    th,td {border:1px solid #333;padding:12px;}
    th {background:#222;}
    tr.green {background:#064e3b;}
    tr.yellow {background:#b3b300;}
    tr.orange {background:#ffa500;}
    tr.red {background:#7f1d1d;color:#fff;}
    .modal {display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);align-items:center;justify-content:center;}
    .modal-content {background:#111;padding:20px;border-radius:8px;width:300px;text-align:center;}
    .modal-content h3 {margin-top:0;}
    .modal-content input,.modal-content select {width:90%;margin:8px 0;padding:8px;border:none;border-radius:4px;background:#222;color:#fff;text-align:center;}
    .modal-content button {margin-top:10px;}
    #searchCpf {margin:10px 0;padding:8px;border:none;border-radius:4px;background:#222;color:#fff;text-align:center;width:200px;}
  </style>
</head>
<body>
<h2>Radar de Limites</h2>

<input id="searchCpf" placeholder="Pesquisar CPF" maxlength="14">

<div>
  <button onclick="openModal('lancar')">Lançar Limite</button>
  <button onclick="openModal('tomar')">Tomar Crédito</button>
</div>

<table id="tabela">
  <thead>
    <tr>
      <th>Nº do Limite</th>
      <th>Safra</th>
      <th>Nome</th>
      <th>CPF</th>
      <th>Limite Total</th>
      <th>Tomado</th>
      <th>% Tomado</th>
      <th>Disponível</th>
      <th>% Disponível</th>
      <th>Data Aprovação</th>
      <th>Data da Tomada</th>
      <th>Data Expiração</th>
      <th>Dias até Expiração</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<!-- Modal Lançar -->
<div class="modal" id="modalLancar">
  <div class="modal-content">
    <h3>Lançar Limite</h3>
    <input id="nome" placeholder="Nome">
    <input id="cpf" placeholder="CPF" maxlength="14">
    <select id="safra">
      <option value="2025/2026" selected>2025/2026</option>
      <option value="2026/2027">2026/2027</option>
    </select>
    <input id="valor" placeholder="Valor Aprovado">
    <input id="aprovacao" type="date">
    <button onclick="lancarLimite()">Confirmar</button>
    <button onclick="closeModal('lancar')">Fechar</button>
  </div>
</div>

<!-- Modal Tomar -->
<div class="modal" id="modalTomar">
  <div class="modal-content">
    <h3>Tomar Crédito</h3>
    <input id="cpfTomar" placeholder="CPF" maxlength="14">
    <input id="valorTomar" placeholder="Valor a Tomar">
    <button onclick="tomarCredito()">Confirmar</button>
    <button onclick="closeModal('tomar')">Fechar</button>
  </div>
</div>

<script>
const firebaseConfig={apiKey:"AIzaSyBzkv1c6w0hTcJs-Cydqr1H4mHMmHUDDwE",authDomain:"limites-fd5a6.firebaseapp.com",projectId:"limites-fd5a6",storageBucket:"limites-fd5a6.appspot.com",messagingSenderId:"51777773197",appId:"1:51777773197:web:c998aed25346219aeecf14"};
firebase.initializeApp(firebaseConfig);
const db=firebase.firestore();
let limites=[];let filtroCpf="";

function openModal(tipo){document.getElementById(tipo==='lancar'?'modalLancar':'modalTomar').style.display='flex';}
function closeModal(tipo){document.getElementById(tipo==='lancar'?'modalLancar':'modalTomar').style.display='none';}
function diasEntre(data){return Math.floor((new Date()-new Date(data+"T00:00:00"))/(1000*60*60*24));}

function formatCPF(cpf){return cpf.replace(/\D/g,"").replace(/(\d{3})(\d{3})(\d{3})(\d{2})/,"$1.$2.$3-$4");}
function formatMoney(v){return v.toLocaleString("pt-BR",{style:"currency",currency:"BRL"});}

function render(){
  const tbody=document.querySelector("#tabela tbody");
  tbody.innerHTML="";
  const hoje=new Date();hoje.setHours(0,0,0,0);

  limites.filter(l=>!filtroCpf||l.cpf.includes(filtroCpf)).forEach((l,index)=>{
    const tr=document.createElement("tr");
    const aprov=new Date(l.dataAprovacao+"T00:00:00");
    const dias=diasEntre(l.dataAprovacao);
    let disponivel=l.limiteTotal-l.tomado;
    let percTomado=l.limiteTotal>0?((l.tomado/l.limiteTotal)*100).toFixed(1):"0.0";
    let percDisponivel=l.limiteTotal>0?((disponivel/l.limiteTotal)*100).toFixed(1):"0.0";

    let expStr="";let diasVenc="";let classe="";let tomadaStr=l.dataTomada?new Date(l.dataTomada).toLocaleDateString("pt-BR"):"-";

    if(disponivel<=0){
      classe="red";
      expStr="TOMADO";
      diasVenc="TOMADO";
    }else if(dias>90){
      classe="red";
      disponivel=0;
      expStr="EXPIRADO";
      diasVenc="EXPIRADO";
    }else if(dias<=7){
      classe="green";
      expStr=new Date(aprov.getTime()+90*24*60*60*1000).toLocaleDateString("pt-BR");
      diasVenc=90-dias;
    }else if(dias<=30){
      classe="yellow";
      expStr=new Date(aprov.getTime()+90*24*60*60*1000).toLocaleDateString("pt-BR");
      diasVenc=90-dias;
    }else{
      classe="orange";
      expStr=new Date(aprov.getTime()+90*24*60*60*1000).toLocaleDateString("pt-BR");
      diasVenc=90-dias;
    }

    tr.className=classe;
    tr.innerHTML=`
      <td>${index+1}</td>
      <td>${l.safra}</td>
      <td>${l.nome}</td>
      <td>${formatCPF(l.cpf)}</td>
      <td>${formatMoney(l.limiteTotal)}</td>
      <td>${formatMoney(l.tomado)}</td>
      <td>${percTomado}%</td>
      <td>${formatMoney(disponivel)}</td>
      <td>${percDisponivel}%</td>
      <td>${new Date(l.dataAprovacao+"T00:00:00").toLocaleDateString("pt-BR")}</td>
      <td>${tomadaStr}</td>
      <td>${expStr}</td>
      <td>${diasVenc}</td>`;
    tbody.appendChild(tr);
  });
}

function salvarNoFirebase(){limites.forEach((l,i)=>{db.collection("limites").doc(l.cpf+"_"+i).set(l);});}
function carregarDoFirebase(){db.collection("limites").get().then(snapshot=>{limites=[];snapshot.forEach(doc=>{limites.push(doc.data());});render();});}

function lancarLimite(){
  const nome=document.getElementById("nome").value;
  const cpf=document.getElementById("cpf").value.replace(/\D/g,"");
  const valor=parseFloat(document.getElementById("valor").value.replace(/\D/g,""))/100;
  const aprov=document.getElementById("aprovacao").value;
  const safra=document.getElementById("safra").value;
  if(!nome||!cpf||cpf.length!==11||!valor||!aprov)return alert("Preencha todos os campos corretamente");
  limites.push({nome,cpf,safra,limiteTotal:valor,tomado:0,dataAprovacao:aprov,dataTomada:null});
  closeModal('lancar');render();salvarNoFirebase();
}
function tomarCredito(){
  const cpf=document.getElementById("cpfTomar").value.replace(/\D/g,"");
  const valor=parseFloat(document.getElementById("valorTomar").value.replace(/\D/g,""))/100;
  let cliente=limites.find(l=>l.cpf===cpf&&l.limiteTotal-l.tomado>0);
  if(!cliente)return alert("Cliente não encontrado ou sem limite disponível");
  const dias=diasEntre(cliente.dataAprovacao);
  if(dias>90)return alert("Limite expirado");
  const disponivel=cliente.limiteTotal-cliente.tomado;
  if(valor>disponivel)return alert("Valor solicitado maior que disponível");
  cliente.tomado+=valor;cliente.dataTomada=new Date().toISOString();
  closeModal('tomar');render();salvarNoFirebase();
}

// Máscaras
function aplicarMascaraCPF(input){
  input.addEventListener("input",()=>{let v=input.value.replace(/\D/g,"");if(v.length>11)v=v.slice(0,11);
    input.value=v.replace(/(\d{3})(\d{3})(\d{3})(\d{0,2})/,(m,p1,p2,p3,p4)=>p4?`${p1}.${p2}.${p3}-${p4}`:`${p1}.${p2}.${p3}`);});
}
function aplicarMascaraMoeda(input){
  input.addEventListener("input",()=>{let v=input.value.replace(/\D/g,"");if(v==="")v="0";v=(parseFloat(v)/100).toFixed(2);
    input.value=v.replace(".",",").replace(/\B(?=(\d{3})+(?!\d))/g,".");});
}

window.onload=function(){
  carregarDoFirebase();
  aplicarMascaraCPF(document.getElementById("cpf"));
  aplicarMascaraCPF(document.getElementById("cpfTomar"));
  aplicarMascaraCPF(document.getElementById("searchCpf"));
  aplicarMascaraMoeda(document.getElementById("valor"));
  aplicarMascaraMoeda(document.getElementById("valorTomar"));
  document.getElementById("searchCpf").addEventListener("input",e=>{
    filtroCpf=e.target.value.replace(/\D/g,"");render();
  });
};
</script>
</body>
</html>
